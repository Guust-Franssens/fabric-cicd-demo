name: Fabric CD - Deploy to Production

on:
  push:
    branches:
      - main
      - ppe
  workflow_dispatch:

jobs:
  deploy-production:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Fabric CLI
        run: |
          # Install Fabric CLI
          pip install ms-fabric-cli jq

          # Verify installation
          fab --version

          # Set config and login
          fab config set encryption_fallback_enabled true
          fab auth login -u "${{ secrets.CLIENT_ID }}" -p "${{ secrets.CLIENT_SECRET }}" --tenant "${{ secrets.TENANT_ID }}"
          fab auth status

      - name: Set environment variables
        run: |
          BRANCH_NAME="${GITHUB_REF#refs/heads/}"
          echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV
          echo "PROJECT_NAME=${{ vars.PROJECT_NAME }}" >> $GITHUB_ENV
          
          # Set workspace ID based on branch
          case "$BRANCH_NAME" in
            main)
              echo "ENVIRONMENT=prod" >> $GITHUB_ENV
              ;;
            ppe)
              echo "ENVIRONMENT=ppe" >> $GITHUB_ENV
              ;;
            *)
              echo "Unknown branch: $BRANCH_NAME"
              exit 1
              ;;
          esac

      - name: Run CD script
        env:
          CLIENT_ID: ${{ secrets.CLIENT_ID }}
          CLIENT_SECRET: ${{ secrets.CLIENT_SECRET }}
          TENANT_ID: ${{ secrets.TENANT_ID }}
          CAPACITY_NAME: ${{ vars.CAPACITY_NAME }}
        run: |
          chmod +x ./scripts/cd.bash
          ./scripts/cd.bash

      - name: Summary
        run: |
          echo "## Deployment Complete âœ…" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${BRANCH_NAME}" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: ${ENVIRONMENT}" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: Successfully deployed" >> $GITHUB_STEP_SUMMARY
