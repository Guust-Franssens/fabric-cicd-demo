name: Fabric CI - Create Feature Workspace

on:
  create:
    branches:
      - '**'
  push:
    branches:
      - 'feature/**'
      - 'dev/**'

jobs:
  create-workspace:
    runs-on: ubuntu-latest
    # Only run for branch creation or pushes to feature branches
    if: github.event_name == 'create' || startsWith(github.ref, 'refs/heads/feature/') || startsWith(github.ref, 'refs/heads/fix/')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Fabric CLI
        run: |
          # Install Fabric CLI
          pip install git+https://github.com/microsoft/fabric-cli.git
          
          # Verify installation
          fab --version

      - name: Authenticate to Fabric
        env:
          FABRIC_CLIENT_ID: ${{ secrets.FABRIC_CLIENT_ID }}
          FABRIC_CLIENT_SECRET: ${{ secrets.FABRIC_CLIENT_SECRET }}
          FABRIC_TENANT_ID: ${{ secrets.FABRIC_TENANT_ID }}
        run: |
          # Authenticate using service principal
          fab auth login --service-principal \
            --client-id $FABRIC_CLIENT_ID \
            --client-secret $FABRIC_CLIENT_SECRET \
            --tenant-id $FABRIC_TENANT_ID

      - name: Set environment variables
        run: |
          echo "BRANCH_NAME=${GITHUB_REF#refs/heads/}" >> $GITHUB_ENV
          echo "PROJECT_NAME=${{ secrets.PROJECT_NAME }}" >> $GITHUB_ENV
          echo "GIT_REPO_OWNER=${{ github.repository_owner }}" >> $GITHUB_ENV
          echo "GIT_REPO_NAME=${{ github.event.repository.name }}" >> $GITHUB_ENV

      - name: Run CI script
        env:
          CAPACITY_NAME: ${{ secrets.CAPACITY_NAME }}
          PE_RESOURCE_ID: ${{ secrets.PE_RESOURCE_ID }}
          GIT_CONNECTION_NAME: ${{ secrets.GIT_CONNECTION_NAME }}
          SECGROUP_ADMINS_ID: ${{ secrets.SECGROUP_ADMINS_ID }}
          SECGROUP_ADMINS_NAME: ${{ secrets.SECGROUP_ADMINS_NAME }}
          SECGROUP_DEVS_ID: ${{ secrets.SECGROUP_DEVS_ID }}
          SECGROUP_DEVS_NAME: ${{ secrets.SECGROUP_DEVS_NAME }}
        run: |
          chmod +x ./scripts/ci.bash
          ./scripts/ci.bash

      - name: Summary
        run: |
          echo "## Fabric Workspace Created âœ…" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${GITHUB_REF#refs/heads/}" >> $GITHUB_STEP_SUMMARY
          echo "- **Workspace**: ${PROJECT_NAME}.Workspace" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: Successfully deployed" >> $GITHUB_STEP_SUMMARY
